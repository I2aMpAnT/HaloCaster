<!DOCTYPE html>
<html>
    <head>
        <script src="websocket_client.js"></script>
        <script src="config.js"></script>
        <style>
            @font-face {
                font-family: 'HighwayGothic';
                src: url('highway-gothic.ttf') format('truetype');
                font-weight: normal;
                font-style: normal;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'HighwayGothic', 'Arial Narrow', Arial, sans-serif;
                background-color: transparent;
                color: white;
                text-shadow: 1px 1px 1px black;
            }

            #scoreboard-container {
                width: 340px;
            }

            /* Team Score Header Rows */
            .team-score-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 12px;
                font-size: 18px;
                font-weight: bold;
            }

            .team-score-row.red { background: rgba(180, 50, 50, 0.95); }
            .team-score-row.blue { background: rgba(60, 90, 160, 0.95); }
            .team-score-row.yellow { background: rgba(180, 180, 50, 0.95); }
            .team-score-row.green { background: rgba(50, 160, 50, 0.95); }
            .team-score-row.purple { background: rgba(130, 50, 160, 0.95); }
            .team-score-row.orange { background: rgba(200, 120, 50, 0.95); }
            .team-score-row.brown { background: rgba(120, 80, 50, 0.95); }
            .team-score-row.pink { background: rgba(200, 100, 150, 0.95); }

            /* Gap between headers and players */
            .team-gap {
                height: 8px;
            }

            /* Player Row */
            .player-row {
                display: flex;
                align-items: center;
                padding: 4px 8px;
                font-size: 14px;
            }

            .player-row.red { background: rgba(180, 50, 50, 0.9); }
            .player-row.blue { background: rgba(60, 90, 160, 0.9); }
            .player-row.yellow { background: rgba(180, 180, 50, 0.9); }
            .player-row.green { background: rgba(50, 160, 50, 0.9); }
            .player-row.purple { background: rgba(130, 50, 160, 0.9); }
            .player-row.orange { background: rgba(200, 120, 50, 0.9); }
            .player-row.brown { background: rgba(120, 80, 50, 0.9); }
            .player-row.pink { background: rgba(200, 100, 150, 0.9); }

            .player-emblem {
                width: 26px;
                height: 26px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 6px;
            }

            .player-emblem img {
                width: 24px;
                height: 24px;
            }

            .dead-x {
                font-size: 24px;
                color: #ff0000;
                font-weight: bold;
                text-shadow: 1px 1px 2px black, -1px -1px 1px black;
            }

            .player-name {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 80px;
            }

            .player-weapon {
                width: 40px;
                height: 22px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 4px;
            }

            .player-weapon img {
                max-width: 36px;
                max-height: 18px;
            }

            .player-stats {
                display: flex;
                align-items: center;
                gap: 2px;
                font-size: 12px;
            }

            .stat-label {
                color: #aaa;
                margin-right: 1px;
            }

            .stat-value {
                min-width: 14px;
                text-align: right;
            }

            .stat-group {
                display: flex;
                align-items: center;
                margin-left: 4px;
            }

            #connection-status {
                position: fixed;
                bottom: 5px;
                right: 5px;
                font-size: 10px;
                color: #888;
            }

            #team-headers {
                display: flex;
                flex-direction: column;
            }
        </style>
    </head>
    <body>
        <div id="scoreboard-container">
            <div id="team-headers"></div>
            <div class="team-gap"></div>
            <div id="players-container"></div>
        </div>
        <div id="connection-status">Connecting...</div>

        <script>
            const client = new websocket_client();
            let updateInterval;

            let fullData = {};
            let scoreboardData = {};
            let currentGameType = 'slayer';

            const teamNames = {
                0: 'Red Team', 1: 'Blue Team', 2: 'Yellow Team', 3: 'Green Team',
                4: 'Purple Team', 5: 'Orange Team', 6: 'Brown Team', 7: 'Pink Team'
            };
            const teamClasses = {
                0: 'red', 1: 'blue', 2: 'yellow', 3: 'green',
                4: 'purple', 5: 'orange', 6: 'brown', 7: 'pink'
            };

            async function init() {
                const wsUrl = `ws://${window.config.host}:${window.config.port}`;

                try {
                    await client.connect(wsUrl);
                    document.getElementById('connection-status').textContent = '';

                    client.add_message_recieved_callback('get_players', handlePlayers);
                    client.add_message_recieved_callback('get_variant_details', handleVariantDetails);
                    client.add_message_recieved_callback('error', handleError);
                    client.add_message_recieved_callback('close', handleDisconnect);

                    requestData();
                    updateInterval = setInterval(requestData, 500);

                } catch (error) {
                    document.getElementById('connection-status').textContent = 'Connection failed';
                    setTimeout(init, 3000);
                }
            }

            function requestData() {
                client.request_players("full");
                client.request_players("scoreboard");
                client.request_variant_details();
            }

            function handleDisconnect() {
                document.getElementById('connection-status').textContent = 'Reconnecting...';
                if (updateInterval) clearInterval(updateInterval);
                setTimeout(init, 3000);
            }

            function handleError(error) {}

            function handleVariantDetails(details) {
                if (details && details.game_type) {
                    currentGameType = details.game_type.toLowerCase();
                }
            }

            function isObjectiveGame() {
                const gt = currentGameType.toLowerCase();
                return gt.includes('ctf') || gt.includes('flag') || gt.includes('assault') ||
                       gt.includes('oddball') || gt.includes('king') || gt.includes('hill') ||
                       gt.includes('territories') || gt.includes('juggernaut') ||
                       gt === 'capture_the_flag';
            }

            function getObjectiveScore(gameStats) {
                if (!gameStats) return 0;
                const gt = currentGameType.toLowerCase();

                // CTF
                if (gt.includes('ctf') || gt.includes('flag') || gt === 'capture_the_flag') {
                    return gameStats.ctf_scores || gameStats.Ctf_scores || gameStats.CTF_scores || 0;
                }
                // Assault
                if (gt.includes('assault')) {
                    return gameStats.assault_score || gameStats.Assault_score || 0;
                }
                // Oddball
                if (gt.includes('oddball')) {
                    return gameStats.oddball_score || gameStats.Oddball_score || 0;
                }
                // KOTH
                if (gt.includes('king') || gt.includes('hill')) {
                    return gameStats.koth_kills_as_king || gameStats.Koth_kills_as_king || 0;
                }
                // Territories
                if (gt.includes('territories')) {
                    return gameStats.territories_taken || gameStats.Territories_taken || 0;
                }
                // Juggernaut
                if (gt.includes('juggernaut')) {
                    return gameStats.juggernaut_time || gameStats.Juggernaut_time || 0;
                }
                return 0;
            }

            function handlePlayers(playersData, type) {
                // Detect type based on data structure
                const firstPlayer = playersData[Object.keys(playersData)[0]];
                if (firstPlayer && firstPlayer.game_stats !== undefined) {
                    fullData = playersData;
                } else {
                    scoreboardData = playersData;
                }

                renderScoreboard();
            }

            function renderScoreboard() {
                const teams = {};
                const isObj = isObjectiveGame();

                // Process full data for stats
                Object.keys(fullData).forEach(playerName => {
                    const p = fullData[playerName];
                    const stats = p.game_stats || {};
                    const playerInfo = p.player || {};
                    const profile = playerInfo.profile_traits?.profile || {};
                    const emblemInfo = profile.emblem_info || {};

                    const teamIndex = playerInfo.team_index;
                    if (teamIndex === undefined) return;

                    // Get scoreboard data for this player (weapon, is_dead)
                    const sb = scoreboardData[playerName] || {};

                    const kills = stats.kills || 0;
                    const deaths = stats.deaths || 0;
                    const assists = stats.assists || 0;
                    const objScore = getObjectiveScore(stats);

                    const playerData = {
                        name: playerName,
                        kills: kills,
                        deaths: deaths,
                        assists: assists,
                        obj_score: objScore,
                        score: isObj ? objScore : kills,
                        is_dead: sb.is_dead === 'True' || sb.is_dead === true,
                        current_weapon: sb.current_weapon || 'None',
                        emblem_foreground: emblemInfo.foreground_emblem,
                        emblem_background: emblemInfo.background_emblem,
                        primary_color: profile.primary_color,
                        secondary_color: profile.secondary_color,
                        tertiary_color: profile.tertiary_color,
                        quaternary_color: profile.quaternary_color
                    };

                    if (!teams[teamIndex]) {
                        teams[teamIndex] = { players: [], totalScore: 0 };
                    }
                    teams[teamIndex].players.push(playerData);
                    teams[teamIndex].totalScore += playerData.score;
                });

                // Sort teams by index
                const sortedTeamIndices = Object.keys(teams).map(Number).sort((a, b) => a - b);

                // Render team headers
                let headersHtml = '';
                sortedTeamIndices.forEach(teamIndex => {
                    const teamClass = teamClasses[teamIndex] || 'red';
                    const teamName = teamNames[teamIndex] || 'Team ' + teamIndex;
                    headersHtml += `
                        <div class="team-score-row ${teamClass}">
                            <span>${teamName}</span>
                            <span>${teams[teamIndex].totalScore}</span>
                        </div>
                    `;
                });
                document.getElementById('team-headers').innerHTML = headersHtml;

                // Render players by team
                let playersHtml = '';
                sortedTeamIndices.forEach(teamIndex => {
                    const teamClass = teamClasses[teamIndex] || 'red';
                    const teamPlayers = teams[teamIndex].players;

                    // Sort by score descending
                    teamPlayers.sort((a, b) => b.score - a.score);

                    teamPlayers.forEach(player => {
                        const emblemUrl = getEmblemUrl(player);
                        const weaponImg = getWeaponImage(player.current_weapon);

                        const emblemContent = player.is_dead
                            ? '<span class="dead-x">X</span>'
                            : `<img src="${emblemUrl}" alt="" onerror="this.style.visibility='hidden'">`;

                        playersHtml += `
                            <div class="player-row ${teamClass}">
                                <div class="player-emblem">${emblemContent}</div>
                                <span class="player-name">${player.name}</span>
                                <div class="player-weapon">${weaponImg}</div>
                                <div class="player-stats">
                                    ${isObj ? `<span class="stat-group"><span class="stat-label">S</span><span class="stat-value">${player.obj_score}</span></span>` : ''}
                                    <span class="stat-group"><span class="stat-label">K</span><span class="stat-value">${player.kills}</span></span>
                                    <span class="stat-group"><span class="stat-label">D</span><span class="stat-value">${player.deaths}</span></span>
                                    <span class="stat-group"><span class="stat-label">A</span><span class="stat-value">${player.assists}</span></span>
                                </div>
                            </div>
                        `;
                    });
                });
                document.getElementById('players-container').innerHTML = playersHtml;
            }

            function getEmblemUrl(player) {
                if (player.emblem_foreground === undefined) return '';
                return `https://www.halo2pc.com/test-pages/CartoStat/Emblem/emblem.php?P=${player.primary_color}&S=${player.secondary_color}&EP=${player.tertiary_color}&ES=${player.quaternary_color}&EF=${player.emblem_foreground}&EB=${player.emblem_background}&ET=0`;
            }

            function getWeaponImage(weaponName) {
                if (!weaponName || weaponName === 'None') return '';
                const weaponFile = weaponName.replace(/\s+/g, '');
                return `<img src="Weapons/${weaponFile}.png" alt="" onerror="this.parentElement.innerHTML=''">`;
            }

            init();
        </script>
    </body>
</html>
