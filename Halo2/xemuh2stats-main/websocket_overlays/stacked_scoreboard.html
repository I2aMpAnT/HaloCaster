<!DOCTYPE html>
<html>
    <head>
        <script src="websocket_client.js"></script>
        <script src="config.js"></script>
        <style>
            @font-face {
                font-family: 'UniversCondensedBold';
                src: url('univers67condensedbold.otf') format('opentype');
                font-weight: bold;
                font-style: normal;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'UniversCondensedBold', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: transparent;
                color: white;
            }

            #scoreboard-container {
                width: 380px;
                background: rgba(0, 0, 0, 0.75);
            }

            /* Team Score Header Rows */
            .team-score-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 12px;
                font-size: 18px;
                font-weight: bold;
            }

            .team-score-row.red {
                color: #ff6666;
            }

            .team-score-row.blue {
                color: #6699ff;
            }

            .team-name {
                text-shadow: 1px 1px 2px black;
            }

            .team-score {
                text-shadow: 1px 1px 2px black;
            }

            /* Team Divider */
            .team-divider {
                height: 2px;
                background: #cc0000;
                margin: 0;
            }

            /* Player Row */
            .player-row {
                display: flex;
                align-items: center;
                padding: 2px 8px;
                font-size: 14px;
            }

            .player-emblem {
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: rgba(0,0,0,0.3);
            }

            .player-emblem img {
                width: 22px;
                height: 22px;
            }

            .dead-x {
                font-size: 22px;
                color: #ff0000;
                font-weight: bold;
                text-shadow: 1px 1px 1px black, -1px -1px 1px black;
                line-height: 1;
            }

            .player-weapon {
                width: 32px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-left: 4px;
            }

            .player-weapon img {
                max-width: 28px;
                max-height: 16px;
                filter: brightness(1.1);
            }

            .player-name {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-shadow: 1px 1px 2px black;
                margin-left: 6px;
            }

            .player-stats {
                display: flex;
                gap: 2px;
                margin-left: 8px;
            }

            .player-stat {
                width: 24px;
                text-align: center;
                font-weight: bold;
                text-shadow: 1px 1px 2px black;
                font-size: 13px;
            }

            .stat-k { color: #88ff88; }
            .stat-d { color: #ff8888; }
            .stat-a { color: #88aaff; }
            .stat-obj { color: #ffff66; }

            #connection-status {
                position: fixed;
                bottom: 5px;
                right: 5px;
                font-size: 10px;
                color: #888;
            }
        </style>
    </head>
    <body>
        <div id="scoreboard-container">
            <!-- Team Score Headers -->
            <div class="team-score-row red">
                <span class="team-name">Red Team</span>
                <span class="team-score" id="red-score">0</span>
            </div>
            <div class="team-score-row blue">
                <span class="team-name">Blue Team</span>
                <span class="team-score" id="blue-score">0</span>
            </div>

            <!-- Red Team Players -->
            <div id="red-players"></div>
            <div class="team-divider"></div>

            <!-- Blue Team Players -->
            <div id="blue-players"></div>
        </div>
        <div id="connection-status">Connecting...</div>

        <script>
            const client = new websocket_client();
            let updateInterval;

            // Store last known players to persist display
            let lastRedPlayers = [];
            let lastBluePlayers = [];
            let currentGameType = 'slayer';

            async function init() {
                const wsUrl = `ws://${window.config.host}:${window.config.port}`;

                try {
                    await client.connect(wsUrl);
                    document.getElementById('connection-status').textContent = '';

                    client.add_message_recieved_callback('get_players', handlePlayers);
                    client.add_message_recieved_callback('get_variant_details', handleVariantDetails);
                    client.add_message_recieved_callback('error', handleError);
                    client.add_message_recieved_callback('close', handleDisconnect);

                    requestData();
                    updateInterval = setInterval(requestData, 500);

                } catch (error) {
                    document.getElementById('connection-status').textContent = 'Connection failed';
                    setTimeout(init, 3000);
                }
            }

            function requestData() {
                client.request_players("full");
                client.request_variant_details();
            }

            function handleDisconnect() {
                document.getElementById('connection-status').textContent = 'Reconnecting...';
                if (updateInterval) clearInterval(updateInterval);
                setTimeout(init, 3000);
            }

            function handleError(error) {
                // Keep existing display on error
            }

            function handleVariantDetails(details) {
                if (details && details.game_type) {
                    currentGameType = details.game_type.toLowerCase();
                }
            }

            function isObjectiveGame() {
                return ['capture_the_flag', 'assault', 'oddball', 'king_of_the_hill', 'territories', 'juggernaut'].includes(currentGameType);
            }

            function getObjectiveScore(player) {
                if (!player.game_stats) return 0;
                const stats = player.game_stats;
                switch (currentGameType) {
                    case 'capture_the_flag':
                        return stats.ctf_scores || 0;
                    case 'assault':
                        return stats.assault_score || 0;
                    case 'oddball':
                        return stats.oddball_score || 0;
                    case 'king_of_the_hill':
                        return stats.koth_kills_as_king || 0;
                    case 'territories':
                        return stats.territories_taken || 0;
                    case 'juggernaut':
                        return stats.juggernaut_time || 0;
                    default:
                        return 0;
                }
            }

            function handlePlayers(playersData) {
                let redPlayers = [];
                let bluePlayers = [];
                let redScore = 0;
                let blueScore = 0;

                const playerNames = Object.keys(playersData);
                const isObj = isObjectiveGame();

                playerNames.forEach(playerName => {
                    const player = playersData[playerName];
                    const kills = player.game_stats ? player.game_stats.kills : 0;
                    const deaths = player.game_stats ? player.game_stats.deaths : 0;
                    const assists = player.game_stats ? player.game_stats.assists : 0;
                    const objScore = getObjectiveScore(player);

                    const playerData = {
                        name: playerName,
                        kills: kills,
                        deaths: deaths,
                        assists: assists,
                        obj_score: objScore,
                        is_dead: player.player && player.player.respawn_time !== 0,
                        current_weapon: 'None',
                        emblem_foreground: player.player?.profile_traits?.profile?.emblem_info?.foreground_emblem,
                        emblem_background: player.player?.profile_traits?.profile?.emblem_info?.background_emblem,
                        primary_color: player.player?.profile_traits?.profile?.primary_color,
                        secondary_color: player.player?.profile_traits?.profile?.secondary_color,
                        tertiary_color: player.player?.profile_traits?.profile?.tertiary_color,
                        quaternary_color: player.player?.profile_traits?.profile?.quaternary_color
                    };

                    // Get team from player properties
                    const teamIndex = player.player?.team_index;
                    const isRed = teamIndex === 0 || (typeof teamIndex === 'string' && teamIndex.includes('red'));
                    const isBlue = teamIndex === 1 || (typeof teamIndex === 'string' && teamIndex.includes('blue'));

                    if (isRed) {
                        redPlayers.push(playerData);
                        redScore += isObj ? objScore : kills;
                    } else if (isBlue) {
                        bluePlayers.push(playerData);
                        blueScore += isObj ? objScore : kills;
                    }
                });

                // Sort by objective score for obj games, kills for slayer
                const sortKey = isObj ? 'obj_score' : 'kills';
                redPlayers.sort((a, b) => b[sortKey] - a[sortKey]);
                bluePlayers.sort((a, b) => b[sortKey] - a[sortKey]);

                // Update scores
                document.getElementById('red-score').textContent = redScore;
                document.getElementById('blue-score').textContent = blueScore;

                // Update players
                if (redPlayers.length > 0) {
                    lastRedPlayers = redPlayers;
                }
                if (bluePlayers.length > 0) {
                    lastBluePlayers = bluePlayers;
                }

                renderTeamPlayers('red-players', redPlayers.length > 0 ? redPlayers : lastRedPlayers);
                renderTeamPlayers('blue-players', bluePlayers.length > 0 ? bluePlayers : lastBluePlayers);
            }

            function renderTeamPlayers(containerId, players) {
                const container = document.getElementById(containerId);

                if (!players || players.length === 0) {
                    return;
                }

                const isObj = isObjectiveGame();
                let html = '';
                players.forEach(player => {
                    const emblemUrl = getEmblemUrl(player);
                    const weaponImg = getWeaponImage(player.current_weapon);

                    // Show red X instead of emblem when dead
                    const emblemContent = player.is_dead
                        ? '<span class="dead-x">X</span>'
                        : `<img src="${emblemUrl}" alt="" onerror="this.style.visibility='hidden'">`;

                    html += `
                        <div class="player-row">
                            <div class="player-emblem">
                                ${emblemContent}
                            </div>
                            <div class="player-weapon">${weaponImg}</div>
                            <span class="player-name">${player.name}</span>
                            <div class="player-stats">
                                ${isObj ? `<span class="player-stat stat-obj">${player.obj_score}</span>` : ''}
                                <span class="player-stat stat-k">${player.kills}</span>
                                <span class="player-stat stat-d">${player.deaths}</span>
                                <span class="player-stat stat-a">${player.assists}</span>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function getEmblemUrl(player) {
                if (player.emblem_foreground === undefined) return '';
                return `https://www.halo2pc.com/test-pages/CartoStat/Emblem/emblem.php?P=${player.primary_color}&S=${player.secondary_color}&EP=${player.tertiary_color}&ES=${player.quaternary_color}&EF=${player.emblem_foreground}&EB=${player.emblem_background}&ET=0`;
            }

            function getWeaponImage(weaponName) {
                if (!weaponName || weaponName === 'None') return '';
                const weaponFile = weaponName.replace(/\s+/g, '');
                return `<img src="Weapons/${weaponFile}.png" alt="" onerror="this.style.display='none'">`;
            }

            init();
        </script>
    </body>
</html>
