<!DOCTYPE html>
<html>
    <head>
        <script src="websocket_client.js"></script>
        <script src="config.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@600&display=swap');

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Barlow Condensed', 'Gotham', 'Arial Narrow', sans-serif;
                background-color: transparent;
                color: white;
            }

            #scoreboard-container {
                width: 340px;
            }

            .team-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 10px;
                font-size: 18px;
                font-weight: 600;
                text-shadow: 1px 1px 0px black, -1px -1px 0px black, 1px -1px 0px black, -1px 1px 0px black;
            }

            .team-header.red {
                background-color: #C23A3A;
            }

            .team-header.blue {
                background-color: #3A5AC2;
            }

            .team-name {
                text-transform: uppercase;
            }

            .team-score {
                font-weight: bold;
            }

            .team-gap {
                height: 6px;
            }

            .players-section {
                display: flex;
                flex-direction: column;
            }

            .player-row {
                display: flex;
                align-items: center;
                padding: 3px 8px;
                font-size: 15px;
                text-shadow: 1px 1px 0px black, -1px -1px 0px black, 1px -1px 0px black, -1px 1px 0px black;
            }

            .player-row.red {
                background-color: #8B2332;
            }

            .player-row.blue {
                background-color: #2E4A7D;
            }

            .player-emblem {
                width: 24px;
                height: 24px;
                margin-right: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .player-emblem img {
                max-width: 24px;
                max-height: 24px;
            }

            .dead-x {
                color: #FF0000;
                font-size: 22px;
                font-weight: bold;
                line-height: 1;
            }

            .player-name {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .player-stats {
                display: flex;
                gap: 4px;
                font-size: 14px;
            }

            .stat-label {
                opacity: 0.7;
            }

            .stat-value {
                min-width: 16px;
                text-align: right;
            }

            #connection-status {
                display: none;
            }
        </style>
    </head>
    <body>
        <div id="scoreboard-container">
            <!-- Red Team Header -->
            <div class="team-header red">
                <span class="team-name" id="red-team-name">Red Team</span>
                <span class="team-score" id="red-team-score">0</span>
            </div>
            <!-- Blue Team Header -->
            <div class="team-header blue">
                <span class="team-name" id="blue-team-name">Blue Team</span>
                <span class="team-score" id="blue-team-score">0</span>
            </div>
            <!-- Gap -->
            <div class="team-gap"></div>
            <!-- Players Section -->
            <div id="players-section" class="players-section">
                <!-- Dynamic player rows -->
            </div>
        </div>
        <div id="connection-status">Connecting...</div>

        <script>
            const client = new websocket_client();
            let updateInterval;
            let redTeamData = null;
            let blueTeamData = null;

            async function init() {
                const wsUrl = `ws://${window.config.host}:${window.config.port}`;

                try {
                    await client.connect(wsUrl);
                    document.getElementById('connection-status').textContent = 'Connected';

                    client.add_message_recieved_callback('get_team_scoreboard', handleTeamScoreboard);
                    client.add_message_recieved_callback('close', handleDisconnect);

                    // Request both teams
                    requestBothTeams();

                    // Poll every 500ms
                    updateInterval = setInterval(() => {
                        requestBothTeams();
                    }, 500);

                } catch (error) {
                    document.getElementById('connection-status').textContent = 'Connection failed';
                    console.error('Failed to connect:', error);
                    setTimeout(init, 3000);
                }
            }

            function requestBothTeams() {
                client.request_team_scoreboard(0); // Red
                client.request_team_scoreboard(1); // Blue
            }

            function handleDisconnect() {
                document.getElementById('connection-status').textContent = 'Disconnected - Reconnecting...';
                if (updateInterval) clearInterval(updateInterval);
                setTimeout(init, 3000);
            }

            function handleTeamScoreboard(response) {
                const teamIndex = response.team_index;

                if (teamIndex === 0) {
                    redTeamData = response;
                } else if (teamIndex === 1) {
                    blueTeamData = response;
                }

                renderScoreboard();
            }

            function renderScoreboard() {
                // Update team headers
                if (redTeamData) {
                    document.getElementById('red-team-name').textContent = redTeamData.team_name || 'Red Team';
                    document.getElementById('red-team-score').textContent = redTeamData.team_score || 0;
                }
                if (blueTeamData) {
                    document.getElementById('blue-team-name').textContent = blueTeamData.team_name || 'Blue Team';
                    document.getElementById('blue-team-score').textContent = blueTeamData.team_score || 0;
                }

                // Build player rows
                const playersSection = document.getElementById('players-section');
                let html = '';

                // Red team players
                if (redTeamData && redTeamData.players) {
                    redTeamData.players.forEach(player => {
                        html += buildPlayerRow(player, 'red', redTeamData.game_type);
                    });
                }

                // Blue team players
                if (blueTeamData && blueTeamData.players) {
                    blueTeamData.players.forEach(player => {
                        html += buildPlayerRow(player, 'blue', blueTeamData.game_type);
                    });
                }

                playersSection.innerHTML = html;
            }

            function buildPlayerRow(player, teamColor, gameType) {
                const isDead = player.is_dead;

                // Emblem or dead X
                let emblemHtml;
                if (isDead) {
                    emblemHtml = '<span class="dead-x">X</span>';
                } else if (player.emblem_url) {
                    emblemHtml = `<img src="${player.emblem_url}" alt="">`;
                } else {
                    emblemHtml = '<span style="width:24px;height:24px;background:#444;border-radius:2px;"></span>';
                }

                // Determine if we should show objective stat
                const isSlayer = !gameType || gameType.toLowerCase().includes('slayer');

                // Stats display
                let statsHtml = `
                    <span class="stat-label">K</span>
                    <span class="stat-value">${player.kills || 0}</span>
                    <span class="stat-label">D</span>
                    <span class="stat-value">${player.deaths || 0}</span>
                    <span class="stat-label">A</span>
                    <span class="stat-value">${player.assists || 0}</span>
                `;

                // Add objective stat for non-slayer games
                if (!isSlayer && player.objective_score !== undefined) {
                    statsHtml = `
                        <span class="stat-label">O</span>
                        <span class="stat-value">${player.objective_score || 0}</span>
                    ` + statsHtml;
                }

                return `
                    <div class="player-row ${teamColor}">
                        <div class="player-emblem">${emblemHtml}</div>
                        <span class="player-name">${player.name || 'Unknown'}</span>
                        <div class="player-stats">${statsHtml}</div>
                    </div>
                `;
            }

            // Start
            init();
        </script>
    </body>
</html>
