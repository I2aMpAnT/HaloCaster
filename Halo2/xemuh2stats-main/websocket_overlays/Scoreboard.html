<!DOCTYPE html>
<html>
    <head>
        <script src="websocket_client.js"></script>
        <script src="config.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Overpass:wght@400;600;700&display=swap');

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Overpass', 'Highway Gothic', 'Arial', sans-serif;
                background-color: transparent;
                color: white;
            }

            #scoreboard-container {
                width: 340px;
            }

            .team-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 10px;
                font-size: 18px;
                font-weight: 600;
                text-shadow: 1px 1px 0px black, -1px -1px 0px black, 1px -1px 0px black, -1px 1px 0px black;
            }

            .team-header.red {
                background-color: #C54245;
            }

            .team-header.blue {
                background-color: #4169A8;
            }

            .team-name {
                /* No text-transform - use proper case */
            }

            .team-score {
                font-weight: bold;
            }

            .team-gap {
                height: 6px;
            }

            .players-section {
                display: flex;
                flex-direction: column;
            }

            .player-row {
                display: flex;
                align-items: center;
                padding: 2px 6px;
                font-size: 14px;
                text-shadow: 1px 1px 0px black, -1px -1px 0px black, 1px -1px 0px black, -1px 1px 0px black;
            }

            .player-row.red {
                background-color: #C54245;
            }

            .player-row.blue {
                background-color: #4169A8;
            }

            .player-emblem {
                width: 22px;
                height: 22px;
                margin-right: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .player-emblem img {
                max-width: 22px;
                max-height: 22px;
            }

            .player-emblem iframe {
                width: 22px;
                height: 22px;
                border: none;
                pointer-events: none;
                transform: scale(0.0859375); /* 22/256 = 0.0859375 */
                transform-origin: top left;
                width: 256px;
                height: 256px;
            }

            .emblem-iframe-container {
                width: 22px;
                height: 22px;
                overflow: hidden;
            }

            .dead-x {
                color: #FF0000;
                font-size: 18px;
                font-weight: bold;
                line-height: 1;
                width: 22px;
                height: 22px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }

            .player-name {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .player-weapon {
                width: 22px;
                height: 16px;
                margin-left: 4px;
                margin-right: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .player-weapon img {
                max-width: 22px;
                max-height: 16px;
                filter: brightness(0) invert(1);
            }

            .player-stats {
                display: flex;
                gap: 2px;
                font-size: 13px;
            }

            .stat-label {
                opacity: 0.7;
            }

            .stat-value {
                min-width: 12px;
                text-align: right;
            }

            .objective-icon {
                width: 16px;
                height: 16px;
                margin-right: 2px;
                filter: brightness(0) invert(1);
                vertical-align: middle;
            }

            .objective-stat {
                display: flex;
                align-items: center;
                margin-right: 4px;
            }

            #connection-status {
                display: none;
            }
        </style>
    </head>
    <body>
        <div id="scoreboard-container">
            <!-- Red Team Header -->
            <div class="team-header red">
                <span class="team-name" id="red-team-name">Red Team</span>
                <span class="team-score" id="red-team-score">0</span>
            </div>
            <!-- Blue Team Header -->
            <div class="team-header blue">
                <span class="team-name" id="blue-team-name">Blue Team</span>
                <span class="team-score" id="blue-team-score">0</span>
            </div>
            <!-- Gap -->
            <div class="team-gap"></div>
            <!-- Players Section -->
            <div id="players-section" class="players-section">
                <!-- Dynamic player rows -->
            </div>
        </div>
        <div id="connection-status">Connecting...</div>

        <script>
            const client = new websocket_client();
            let updateInterval;
            let redTeamData = null;
            let blueTeamData = null;

            async function init() {
                const wsUrl = `ws://${window.config.host}:${window.config.port}`;

                try {
                    await client.connect(wsUrl);
                    document.getElementById('connection-status').textContent = 'Connected';

                    client.add_message_recieved_callback('get_team_scoreboard', handleTeamScoreboard);
                    client.add_message_recieved_callback('close', handleDisconnect);

                    // Request both teams
                    requestBothTeams();

                    // Poll every 500ms for responsive time-based scores
                    updateInterval = setInterval(() => {
                        requestBothTeams();
                    }, 500);

                } catch (error) {
                    document.getElementById('connection-status').textContent = 'Connection failed';
                    console.error('Failed to connect:', error);
                    setTimeout(init, 3000);
                }
            }

            function requestBothTeams() {
                client.request_team_scoreboard(0); // Red
                client.request_team_scoreboard(1); // Blue
            }

            function handleDisconnect() {
                document.getElementById('connection-status').textContent = 'Disconnected - Reconnecting...';
                if (updateInterval) clearInterval(updateInterval);
                setTimeout(init, 3000);
            }

            function handleTeamScoreboard(response) {
                console.log('Received team scoreboard:', response);
                const teamIndex = parseInt(response.team_index);

                if (teamIndex === 0) {
                    redTeamData = response;
                } else if (teamIndex === 1) {
                    blueTeamData = response;
                }

                renderScoreboard();
            }

            function renderScoreboard() {
                console.log('Rendering - Red players:', redTeamData?.players, 'Blue players:', blueTeamData?.players);
                // Update team headers
                if (redTeamData) {
                    document.getElementById('red-team-name').textContent = redTeamData.team_name || 'Red Team';
                    document.getElementById('red-team-score').textContent = redTeamData.team_score || 0;
                }
                if (blueTeamData) {
                    document.getElementById('blue-team-name').textContent = blueTeamData.team_name || 'Blue Team';
                    document.getElementById('blue-team-score').textContent = blueTeamData.team_score || 0;
                }

                // Build player rows
                const playersSection = document.getElementById('players-section');
                let html = '';

                // Red team players
                if (redTeamData && redTeamData.players) {
                    console.log('Building red team rows, count:', redTeamData.players.length);
                    redTeamData.players.forEach(player => {
                        console.log('Red player:', player);
                        html += buildPlayerRow(player, 'red', redTeamData.game_type);
                    });
                }

                // Blue team players
                if (blueTeamData && blueTeamData.players) {
                    console.log('Building blue team rows, count:', blueTeamData.players.length);
                    blueTeamData.players.forEach(player => {
                        console.log('Blue player:', player);
                        html += buildPlayerRow(player, 'blue', blueTeamData.game_type);
                    });
                }

                console.log('Final HTML:', html);
                playersSection.innerHTML = html;
            }

            // Map weapon names to icon filenames
            function getWeaponIconPath(weaponName) {
                if (!weaponName || weaponName === 'None') return 'Weapons/None.png';
                // Remove spaces and match to filename
                const cleanName = weaponName.replace(/\s+/g, '');
                return `Weapons/${cleanName}.png`;
            }

            // Format seconds to M:SS
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Get objective score based on game type
            function getObjectiveScore(player, gameType) {
                if (!gameType) return null;
                const gt = gameType.toLowerCase();

                if (gt.includes('ctf') || gt.includes('capture')) {
                    return { icon: 'Weapons/Flag.png', value: player.ctf_scores || 0, isTime: false };
                } else if (gt.includes('assault') || gt.includes('bomb')) {
                    return { icon: 'Weapons/AssaultBomb.png', value: player.assault_score || 0, isTime: false };
                } else if (gt.includes('oddball') || gt.includes('ball')) {
                    return { icon: 'Weapons/OddBall.png', value: player.oddball_score || 0, isTime: true };
                } else if (gt.includes('king') || gt.includes('koth')) {
                    return { icon: 'Weapons/OddBall.png', value: player.koth_time || 0, isTime: true };
                } else if (gt.includes('territories') || gt.includes('territory')) {
                    return { icon: 'Weapons/Flag.png', value: player.territories_taken || 0, isTime: false };
                } else if (gt.includes('juggernaut')) {
                    return { icon: 'Weapons/OddBall.png', value: player.juggernaut_time || 0, isTime: true };
                }
                return null;
            }

            function buildPlayerRow(player, teamColor, gameType) {
                const isDead = player.is_dead;

                // Emblem or dead X
                let emblemHtml;
                if (isDead) {
                    emblemHtml = '<span class="dead-x">X</span>';
                } else if (player.emblem_url) {
                    // Use iframe to render emblem.html (canvas-based emblem)
                    emblemHtml = `<div class="emblem-iframe-container"><iframe src="${player.emblem_url}" scrolling="no"></iframe></div>`;
                } else {
                    emblemHtml = '<span style="width:22px;height:22px;background:#444;border-radius:2px;display:inline-block;"></span>';
                }

                // Weapon icon
                const weaponPath = getWeaponIconPath(player.current_weapon);
                const weaponHtml = `<div class="player-weapon"><img src="${weaponPath}" alt="${player.current_weapon || 'None'}"></div>`;

                // Determine if we should show objective stat
                const isSlayer = !gameType || gameType.toLowerCase().includes('slayer');
                const objective = getObjectiveScore(player, gameType);

                // Stats display
                let statsHtml = `
                    <span class="stat-label">K</span>
                    <span class="stat-value">${player.kills || 0}</span>
                    <span class="stat-label">D</span>
                    <span class="stat-value">${player.deaths || 0}</span>
                    <span class="stat-label">A</span>
                    <span class="stat-value">${player.assists || 0}</span>
                `;

                // Add objective stat for non-slayer games
                if (!isSlayer && objective) {
                    const displayValue = objective.isTime ? formatTime(objective.value) : objective.value;
                    statsHtml = `
                        <span class="stat-label">Score:</span>
                        <span class="stat-value">${displayValue}</span>
                    ` + statsHtml;
                }

                return `
                    <div class="player-row ${teamColor}">
                        <div class="player-emblem">${emblemHtml}</div>
                        ${weaponHtml}
                        <span class="player-name">${player.name || 'Unknown'}</span>
                        <div class="player-stats">${statsHtml}</div>
                    </div>
                `;
            }

            // Start
            init();
        </script>
    </body>
</html>
